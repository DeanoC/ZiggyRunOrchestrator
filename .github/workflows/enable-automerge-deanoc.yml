name: enable-automerge-deanoc

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  issue_comment:
    types:
      - created
      - edited

permissions:
  contents: read
  pull-requests: write

jobs:
  enable-automerge:
    if: ${{ github.event_name != 'issue_comment' || github.event.issue.pull_request != null }}
    runs-on: ubuntu-latest
    steps:
      - name: Enforce manual merge mode
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request?.number ?? context.payload.issue?.number;

            if (!prNumber) {
              core.notice('No pull request in event payload; skipping.');
              return;
            }

            const pull = (await github.rest.pulls.get({ owner, repo, pull_number: prNumber })).data;
            if (pull.state !== 'open') {
              core.notice(`PR #${prNumber} is ${pull.state}; skipping.`);
              return;
            }

            if (!pull.auto_merge) {
              core.info(`Auto-merge already disabled for PR #${prNumber}.`);
              core.notice('Manual merge only policy is active.');
              return;
            }

            try {
              await github.graphql(
                `
                  mutation($pullRequestId: ID!) {
                    disablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId }) {
                      clientMutationId
                    }
                  }
                `,
                { pullRequestId: pull.node_id },
              );
              core.notice(`Disabled auto-merge for PR #${prNumber}. Manual merge only policy is active.`);
            } catch (error) {
              const message = String(error?.message || error);
              if (
                message.includes('is not enabled') ||
                message.includes('auto-merge is disabled') ||
                message.includes('auto merge is disabled') ||
                message.includes('not in the auto-merge queue')
              ) {
                core.info(`Auto-merge already disabled for PR #${prNumber}.`);
                return;
              }
              throw error;
            }
